<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VTU Result Portal - 7th Semester</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #5B59E8;
            --primary-dark: #4845C7;
            --secondary-color: #F8F9FA;
            --text-dark: #2C3E50;
            --text-light: #6C757D;
            --success: #28A745;
            --danger: #DC3545;
            --warning: #FFC107;
            --border: #DEE2E6;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-dark);
        }

        .container { max-width: 1200px; margin: 0 auto; }

        .header { text-align: center; color: white; margin-bottom: 30px; }
        .logo { font-size: 4rem; margin-bottom: 10px; }
        .header h1 { font-size: 2.5rem; margin-bottom: 5px; text-shadow: 0 2px 4px rgba(0,0,0,0.2); font-weight: 800; }
        .subtitle { font-size: 1.1rem; opacity: 0.9; }

        /* Navigation */
        .nav-tabs {
            display: flex; gap: 10px; margin-bottom: 20px;
            background: rgba(255,255,255,0.15); padding: 8px;
            border-radius: 12px; backdrop-filter: blur(10px);
        }
        .tab-btn {
            flex: 1; padding: 12px; border: none;
            background: transparent; color: white;
            font-size: 1rem; cursor: pointer; border-radius: 8px;
            font-weight: 600; transition: all 0.3s ease;
        }
        .tab-btn:hover { background: rgba(255,255,255,0.1); }
        .tab-btn.active { background: white; color: var(--primary-color); shadow: 0 4px 6px rgba(0,0,0,0.1); }

        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Cards */
        .card {
            background: white; border-radius: 16px; padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); margin-bottom: 20px;
        }
        .card h2 { margin-bottom: 20px; font-size: 1.5rem; border-bottom: 2px solid var(--secondary-color); padding-bottom: 10px; }

        /* Forms */
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; color: var(--text-light); text-transform: uppercase; }
        .form-group input {
            width: 100%; padding: 12px; border: 2px solid var(--border);
            border-radius: 8px; font-size: 1rem; font-weight: 600;
            font-family: 'Inter', monospace; transition: border 0.3s;
        }
        .form-group input:focus { outline: none; border-color: var(--primary-color); }

        /* Captcha */
        .captcha-container { display: flex; flex-direction: column; gap: 10px; position: relative; }
        #captcha-image { width: 100%; height: 60px; object-fit: contain; background: #f0f0f0; border-radius: 8px; border: 1px solid var(--border); }
        
        .loading-state {
            padding: 20px; text-align: center; background: #f8f9fa;
            border-radius: 8px; border: 2px dashed #dee2e6;
        }
        .spinner {
            border: 3px solid #e9ecef; border-top: 3px solid var(--primary-color);
            border-radius: 50%; width: 30px; height: 30px;
            animation: spin 1s linear infinite; margin: 0 auto 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Buttons */
        .btn-primary, .btn-secondary {
            padding: 12px; border: none; border-radius: 8px;
            font-weight: 700; cursor: pointer; transition: transform 0.2s;
        }
        .btn-primary { background: var(--primary-color); color: white; width: 100%; font-size: 1.1rem; }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-2px); }
        .btn-primary:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }
        
        .btn-secondary { background: var(--secondary-color); color: var(--text-dark); border: 1px solid var(--border); }
        .btn-secondary:hover { background: #e9ecef; }

        /* Result Display */
        .result-header { background: var(--primary-color); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; }
        .result-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 25px; }
        
        .result-item { background: var(--secondary-color); padding: 15px; border-radius: 10px; text-align: center; }
        .result-item label { display: block; font-size: 0.8rem; text-transform: uppercase; color: var(--text-light); margin-bottom: 5px; }
        .result-item .value { font-size: 1.4rem; font-weight: 800; color: var(--text-dark); }

        /* Table */
        .subjects-table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
        .subjects-table th { background: #f1f5f9; text-align: left; padding: 12px; font-weight: 600; color: var(--text-light); }
        .subjects-table td { padding: 12px; border-bottom: 1px solid var(--border); font-weight: 500; }
        .subjects-table tr:last-child td { border-bottom: none; }

        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 700; text-transform: uppercase; }
        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-danger { background: #fee2e2; color: #991b1b; }

        /* Analysis */
        .analysis-filters { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; }
        .filter-btn { padding: 8px 16px; border: 1px solid var(--border); background: white; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 600; }
        .filter-btn.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }
        
        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: var(--secondary-color); padding: 20px; border-radius: 10px; text-align: center; }
        .stat-card .num { font-size: 2rem; font-weight: 800; }
        .stat-card .lbl { font-size: 0.8rem; text-transform: uppercase; color: var(--text-light); }

        .error-message { background: #fef2f2; color: #991b1b; padding: 15px; border-radius: 8px; border-left: 4px solid var(--danger); }
        .success-message { background: #ecfdf5; color: #065f46; padding: 15px; border-radius: 8px; border-left: 4px solid var(--success); }

        /* Responsive */
        @media (max-width: 600px) {
            .header h1 { font-size: 1.8rem; }
            .nav-tabs { flex-direction: column; }
            .result-grid { grid-template-columns: 1fr 1fr; }
            .stat-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="container">
    <header class="header">
        <div class="logo">üéì</div>
        <h1>VTU RESULT PORTAL</h1>
        <p class="subtitle">7th Semester | 2022 Scheme</p>
    </header>

    <nav class="nav-tabs">
        <button class="tab-btn active" data-tab="check-result">üîç Check Result</button>
        <button class="tab-btn" data-tab="leaderboard">üèÜ Leaderboard</button>
        <button class="tab-btn" data-tab="analysis">üìä Analysis</button>
    </nav>

    <div id="check-result" class="tab-content active">
        <div class="card">
            <h2>Student Details</h2>
            <form id="result-form">
                <div class="form-group">
                    <label>USN</label>
                    <input type="text" id="usn" name="usn" placeholder="1DB22CS..." required pattern="1DB2[1234]CS\d{3}" title="Format: 1DB22CS001">
                </div>
                <div class="form-group">
                    <label>Captcha</label>
                    <div class="captcha-container">
                        <div id="captcha-loading" class="loading-state">
                            <div class="spinner"></div>
                            <p>Loading Captcha...</p>
                        </div>
                        <img id="captcha-image" style="display: none;">
                        <button type="button" id="refresh-captcha" class="btn-secondary">üîÑ Refresh Image</button>
                    </div>
                    <input type="text" id="captcha" name="captcha" placeholder="Enter code" required autocomplete="off" style="margin-top: 10px;">
                </div>
                <button type="submit" id="submit-btn" class="btn-primary">GET RESULT</button>
            </form>
        </div>

        <div id="result-display" class="card result-card" style="display: none;">
            <div id="result-content"></div>
        </div>
    </div>

    <div id="leaderboard" class="tab-content">
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <h2>üèÜ Class Leaderboard</h2>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="search-input" placeholder="Search by USN or Name..." 
                           style="padding: 8px 12px; border: 2px solid var(--border); border-radius: 6px; font-size: 0.9rem; min-width: 200px;">
                    <select id="sort-by" style="padding: 8px; border: 2px solid var(--border); border-radius: 6px;">
                        <option value="marks">Marks</option>
                        <option value="sgpa">SGPA</option>
                    </select>
                    <button id="load-leaderboard" class="btn-secondary" style="padding: 8px 16px;">Load</button>
                </div>
            </div>
            <div id="leaderboard-content"></div>
        </div>
    </div>
    <div id="analysis" class="tab-content">
        <div class="card">
            <h2>üìä Performance Analysis</h2>
            <div class="analysis-filters">
                <button class="filter-btn active" data-category="overall_fail">Overall Failures</button>
                <button class="filter-btn" data-category="fcd">Distinction</button>
                <button class="filter-btn" data-category="fc">First Class</button>
                <button class="filter-btn" data-category="sc">Second Class</button>
                <button class="filter-btn" data-category="BCS701">BCS701</button>
                <button class="filter-btn" data-category="BCS702">BCS702</button>
                <button class="filter-btn" data-category="BCS703">BCS703</button>
                <button class="filter-btn" data-category="BCS714">BCS714</button>
                <button class="filter-btn" data-category="BEE755B">BEE755B</button>
                <button class="filter-btn" data-category="BCS786">BCS786</button>
            </div>
            
            <div id="analysis-stats" class="stat-grid"></div>
            <div id="analysis-content"></div>
        </div>
    </div>

</div>

<script>
    // --- GLOBAL VARIABLES ---
    let captchaRetries = 0;
    const MAX_RETRIES = 3;

    // --- TAB SWITCHING ---
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            btn.classList.add('active');
            document.getElementById(btn.dataset.tab).classList.add('active');
        });
    });

    // --- CAPTCHA LOGIC ---
    function loadCaptcha() {
        const img = document.getElementById('captcha-image');
        const loader = document.getElementById('captcha-loading');
        
        loader.style.display = 'block';
        img.style.display = 'none';
        
        fetch(`/get_captcha?t=${Date.now()}`)
            .then(res => {
                if(!res.ok) throw new Error("Server Busy");
                return res.blob();
            })
            .then(blob => {
                img.src = URL.createObjectURL(blob);
                img.style.display = 'block';
                loader.style.display = 'none';
                captchaRetries = 0;
            })
            .catch(err => {
                console.error(err);
                if(captchaRetries < MAX_RETRIES) {
                    captchaRetries++;
                    setTimeout(loadCaptcha, 2000); // Retry after 2s
                } else {
                    loader.innerHTML = `<p style="color:red">Failed to load. <br><button onclick="loadCaptcha()">Try Again</button></p>`;
                }
            });
    }

    document.getElementById('refresh-captcha').onclick = () => {
        captchaRetries = 0;
        loadCaptcha();
    };

    // --- FETCH RESULT ---
    document.getElementById('result-form').onsubmit = async (e) => {
        e.preventDefault();
        const btn = document.getElementById('submit-btn');
        const display = document.getElementById('result-display');
        const content = document.getElementById('result-content');
        
        btn.disabled = true;
        btn.textContent = "FETCHING...";
        display.style.display = 'none';

        const formData = new FormData(e.target);

        try {
            const res = await fetch('/fetch_result', { method: 'POST', body: formData });
            const data = await res.json();

            display.style.display = 'block';
            if(data.status === 'success') {
                const d = data.data;
                // Render Result
                let rows = d.subjects.map(s => `
                    <tr>
                        <td>${s.code}</td>
                        <td>${s.name}</td>
                        <td>${s.total}</td>
                        <td><span class="badge ${s.result === 'P' ? 'badge-success' : 'badge-danger'}">${s.result}</span></td>
                    </tr>
                `).join('');

                content.innerHTML = `
                    <div class="result-header">
                        <h2>${d.name}</h2>
                        <p>${d.usn}</p>
                    </div>
                    <div class="result-grid">
                        <div class="result-item"><label>SGPA</label><div class="value">${d.sgpa}</div></div>
                        <div class="result-item"><label>Marks</label><div class="value">${d.total_marks}</div></div>
                        <div class="result-item"><label>Rank</label><div class="value">#${d.rank}</div></div>
                        <div class="result-item"><label>Class</label>
                            <div class="value" style="color: ${d.class_result.includes('Fail') ? 'var(--danger)' : 'var(--success)'}; font-size: 1rem;">
                                ${d.class_result}
                            </div>
                        </div>
                    </div>
                    <h3>Subjects</h3>
                    <table class="subjects-table">
                        <thead><tr><th>Code</th><th>Subject</th><th>Marks</th><th>Result</th></tr></thead>
                        <tbody>${rows}</tbody>
                    </table>
                `;
                // Reload captcha for next use
                loadCaptcha();
                document.getElementById('captcha').value = '';
            } else {
                content.innerHTML = `<div class="error-message">‚ùå ${data.message}</div>`;
                if(data.message.includes("Captcha")) loadCaptcha();
            }
        } catch (err) {
            content.innerHTML = `<div class="error-message">‚ùå Network Error. Try again.</div>`;
        }
        btn.disabled = false;
        btn.textContent = "GET RESULT";
    };

    // --- LEADERBOARD ---
    // --- LEADERBOARD ---
document.getElementById('load-leaderboard').onclick = async () => {
    const sort = document.getElementById('sort-by').value;
    const search = document.getElementById('search-input').value.trim();
    const div = document.getElementById('leaderboard-content');
    div.innerHTML = '<div class="loading-state"><div class="spinner"></div><p>Loading...</p></div>';

    const res = await fetch(`/leaderboard?sort=${sort}&search=${encodeURIComponent(search)}`);
    const json = await res.json();

    if(json.status === 'success') {
        if(json.data.length === 0) {
            div.innerHTML = '<div class="error-message">No students found matching your search.</div>';
        } else {
            let rows = json.data.map(s => `
                <tr>
                    <td>#${s.rank}</td>
                    <td>${s.usn}</td>
                    <td>${s.name}</td>
                    <td>${s.total_marks}</td>
                    <td>${s.sgpa}</td>
                    <td><span class="badge ${s.class_result === 'Fail' ? 'badge-danger' : 'badge-success'}">${s.class_result}</span></td>
                </tr>
            `).join('');
            
            div.innerHTML = `
                <table class="subjects-table">
                    <thead><tr><th>Rank</th><th>USN</th><th>Name</th><th>Marks</th><th>SGPA</th><th>Result</th></tr></thead>
                    <tbody>${rows}</tbody>
                </table>
                <p style="margin-top: 15px; color: var(--text-light); font-size: 0.9rem;">
                    Showing ${json.data.length} student${json.data.length !== 1 ? 's' : ''}
                </p>
            `;
        }
    }
};

// Allow Enter key to trigger search
document.getElementById('search-input').addEventListener('keypress', (e) => {
    if(e.key === 'Enter') {
        document.getElementById('load-leaderboard').click();
    }
});

    // --- ANALYSIS ---
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.onclick = async () => {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            const cat = btn.dataset.category;
            const statsDiv = document.getElementById('analysis-stats');
            const contentDiv = document.getElementById('analysis-content');
            
            contentDiv.innerHTML = '<div class="loading-state"><div class="spinner"></div><p>Analyzing...</p></div>';
            
            const res = await fetch(`/get_analysis?category=${cat}`);
            const json = await res.json();
            
            if(json.status === 'success') {
                // Update Stats
                statsDiv.innerHTML = `
                    <div class="stat-card"><div class="num">${json.stats.total}</div><div class="lbl">Total</div></div>
                    <div class="stat-card"><div class="num" style="color:var(--success)">${json.stats.passed}</div><div class="lbl">Passed</div></div>
                    <div class="stat-card"><div class="num" style="color:var(--danger)">${json.stats.failed}</div><div class="lbl">Failed</div></div>
                `;
                
                // Update Table
                if(json.students.length === 0) {
                    contentDiv.innerHTML = '<div class="success-message">No students found in this category.</div>';
                } else {
                    let rows = json.students.map(s => `
                        <tr>
                            <td>${s.usn}</td>
                            <td>${s.name}</td>
                            <td>${s.total_marks}</td>
                            <td>${s.sgpa}</td>
                            <td style="color: ${s.fail_summary || s.fail_marks ? 'var(--danger)' : 'inherit'}">
                                ${s.fail_summary ? 'Failed: ' + s.fail_summary : (s.fail_marks ? s.fail_marks + ' Marks' : s.class_result)}
                            </td>
                        </tr>
                    `).join('');
                    
                    contentDiv.innerHTML = `
                        <table class="subjects-table">
                            <thead><tr><th>USN</th><th>Name</th><th>Marks</th><th>SGPA</th><th>Details</th></tr></thead>
                            <tbody>${rows}</tbody>
                        </table>
                    `;
                }
            }
        };
    });

    // Init
    loadCaptcha();
</script>

</body>
</html>